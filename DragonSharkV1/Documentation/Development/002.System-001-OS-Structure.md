# System Setup : OS Structure

This document describes the details of two images:

1. The development image includes the development tools, like gcc and git.
2. The production image does not include development tools.

This means that, save for these details (development tools), the images are built the same.

In order to properly understand the process and instructions, these steps must be carried in
the order they're documented in this page.

## Base OS image

The base OS can be obtained by checking the [Raspbian Image](https://wiki.banana-pi.org/Banana_Pi_BPI-M5#Raspbian) in the official Banana Pi documentation.

## Initial deployment

It was properly stored in a 16gb-total and partitioned Micro SD card. The next steps are:

1. Apply the first install (the `Install / Restore` section [here](002.System-002-Commands.md)).
2. Apply the additional partitions (the `Additional partitions` section [here](002.System-002-Commands.md)).

### SD Card

This image is burned into an SD card. This image configures the SD card into several partitions.

While other partitions serve storage purpose, the main one has boot capabilities. This means that, once inserted
in the SBC and powered, the OS in the boot partition started running (from the SD card).

## System users

There are three users here. Two of them are built-in:

1. `root`: The root user (0).
2. `pi`: The "normal" user (1000). It's the default-logged user when the console boots.
   1. However, it **is** a _sudoer_. Be careful.

Finally, there's a third user: `gamer`. This one is meant to execute native (ARM64 / web) games. This user does
not have its own `$HOME` directory. It was created specifically for this project and used for the internal
launcher utility.

See the `Creating and maintaining users` section [here](002.System-002-Commands.md) for more details on how the
`gamer` user is created and how to maintain the password of `root` and `pi` users if something screws.

## Filesystem(s) layout

the following partitions are present:

```
mmcblk0 (disk)
+-mmcblk0p1 (part, 256mb) /boot (ext4)
+-mmcblk0p2 (part, ...gb) / (ext4)
+-mmcblk0p3 (part, 23mb) /mnt/CURRENT_SAVE (ext4)
+-mmcblk0p4 (part, 2.2gb) /mnt/SAVES (ext4)
mmcblk0boot0 (disk)
mmcblk0boot1 (disk)
mmcblk0rpmb (disk)
```

Where `mmcblk0p2` stands for the big file system for the major parts of the OS and console in general. Games
(installed and ROMs) will **not** be stored there, however. Only DragonShark-related utilities are contained
in this main partition.

The sizes of `mmcblk0p3` and `mmcblk0p4` might be different if the setup was made different, but the
structure will remain.

## Drivers

Aside from the ALSA drivers, and everything that comes out of the box in the image, this system includes
the Wi-Fi driver `rtl8188eu`, compatible with Wi-Fi dongles.

Bluetooth also comes included, via:

```shell
sudo apt update
sudo apt install -y bluez bluetooth rfkill
sudo systemctl enable --now bluetooth
sudo rfkill unblock bluetooth
```

And also:

```shell
sudo nano /etc/bluetooth/main.conf
```

And filling with the content:

```shell
...more stuff...

[General]
...more stuff...
FastConnectable=true
...more stuff...

[Policy]
...more stuff...
AutoEnable=true
...more stuff...

...more stuff...
```

Pairing of Bluetooth controllers is compatible (e.g. pressing X + HOME button in the Gen Game New S3 gamepads
works like a charm).

## Boot configuration changes

# Configuration Changes:
Some details in the /boot/config.txt file:

```
In order to use a 7" display, I modified /boot/config.txt, uncommenting and changing these variables:

I had to remove:

#framebuffer_width=1280
#framebuffer_height=720

And replace with this:

framebuffer_width=1920
framebuffer_height=1080

# These values match a 7" display. Uncomment them when using a standard LCD Smart TV.
# Changes in that file always require a reboot.

Also, I had to remove:

#hdmi_group=1
#hdmi_mode=1

And -for the same reason- replace them with:

hdmi_group=2
hdmi_mode=82

Also uncomment: hdmi_force_hotplug=1

And add:

hdmi_pixel_encoding=2
hdmi_ignore_edid=0xa5000080
```

These relate to the way the screen resolution is applied.

## Development Tools

This only applies for the development image. Content described here should not be present, or expected to be
present, in the production image.

Compiler tools like `gcc` / `makefile` (essentials) and related tools like `git` are installed.

## Extra packages

Extra fonts are also added:

```shell
sudo apt install fonts-noto fonts-noto-ui-core
```