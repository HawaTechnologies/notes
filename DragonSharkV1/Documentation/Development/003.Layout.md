# Layout

This document, and sub-documents, describe the structure and purpose of the filesystem, not focusing on the
partitions but on the concrete 

Our filesystem is actually broken in 3 parts:

1. The core filesystem (/).
2. The current save (/mnt/CURRENT_SAVE).
3. The saves storage (/mnt/SAVES).

The `/` mount point corresponds to the OS with their tools and infrastructure. The `/mnt/CURRENT_SAVE` has
the per-game storage of the currently executing non-emulated game (HTML5 or ARM64-native). Finally, the
`/mnt/SAVES` contains all the saves from all the games.

## Core filesystem `/`

This is an ext4 system with, basically, the whole system. It contains:

1. The whole system, community tools, and Hawa tools.
2. The current configurations, including:
   1. The paths to emulated games' SAVES (inside /mnt/SAVES).
   2. General configuration(s) of software (incl. RetroArch and EmulationStation).

Its size is like 12GB, and most likely a good amount of ROMs (for consoles like PlayStation) will not fit
there. Roms are meant to be stored in a separate place, with the aid of tools like DragonShark UI or the
respective tool among the DragonShark helpers.

While most of the related concepts were already described in the [System section](002.System.md), particular
concepts related to particular files will be described in this section:

1. The installed libretro cores for retroarch.
2. `es_systems.cfg` and `es_systems.template.cfg`.
3. The emulator configurations.

### libretro cores

20 consoles are supported for emulation, although the hardware may fail to properly make work some of them
(this problem exists with Nintendo 64 so far - ongoing work is done to make it work).

All the cores are installed into `/home/pi/.config/retroarch/cores/`, and properly reached for configuration.

- Atari 2600: `stella204_libretro.so`.
- Atari 5200: `atari800_libretro.so`.
- Atari 7800: `prosystem_libretro.so`.
- Atari Jaguar: `virtualjaguar_libretro.so`.
- Atari Lynx: `mednafen_lynx_libretro.so`.
- DOS Box: `dosbox_libretro.so`.
- SEGA Genesis: `genesis_plus_gx_libretro.so`.
- SEGA Game Gear: `genesis_plus_gx_libretro.so` (yes, same lib).
- SEGA Master System: `genesis_plus_gx_libretro.so` (yes, same lib).
- SEGA CD: `genesis_plus_gx_libretro.so` (yes, same lib).
- Nintendo (NES): `fceumm_libretro.so`.
- Nintendo (SNES): `snes9x2010_libretro.so`.
- Nintendo Gameboy Color: `gambatte_libretro.so`.
- Nintendo Gameboy Advance: `mgba_libretro.so`.
- Nintendo DS: `desmume2015_libretro.so`.
- Nintendo 64: `mupen64plus_next_libretro.so`.
- MAME: `mame_libretro.so`.
- Sony PlayStation: `pcsx_rearmed_libretro.so`.
- NeoGeo CD: `neocd_libretro.so`.
- NeoGeo Pocket: `mednafen_ngp_libretro.so`.

This filesystem must be understood as read-only, owned by `pi` user.

### es_systems.cfg file

This file stands for the configuration for EmulationStation. Users should not edit this file from scratch, for
the file is generated from es_systems.template.cfg (described next) via one of the DragonShark helper tools.

It's initial state is described [here](003.Layout-001-ES_Systems.md).

### es_system.template.cfg file

This file stands for the configuration for EmulationStation. Users should only edit this file when they do what
they're doing (typically, to add an extra emulator or stuff like that). Each entry has a reference to the `%ROMS%`
variable, which is something understood by a DragonShark helper tool. Adding a new entry must make use of that
variable to refer where the roms are stored for that emulated machine as well.

Its contents are described [here](003.Layout-002-ES_Systems_Template.md).

### Emulators configuration files

The only emulator configurations that come out of the box are related to save directories. Save directories will
be described later. This section does not apply to DragonShark games, only emulated ones.

They're detailed [here](003.Layout-003-SaveConfigs.md).

## Current Save filesystem `/mnt/CURRENT_SAVE`

The current save is a _public filesystem_. It's meant to be totally public and writable by the _currently executing
game_. Nothing is audited there.

Also, `/mnt/CURRENT_SAVE` is symlinked as `/home/gamer`, since _that one_ is the user that will run games, and it might
happen that games write in the local `$HOME` directory (or an inferred one, which will typically be `/home/gamer`).

Its size is like 20MB. More than enough for most games, since there are _no_ assets here. This implies another
restriction (which is intentional / for user security): It's a very small amount so no caching of downloaded assets
should occur here. Games should be _complete_ in content.

Emulated games (RetroArch, EmulationStation) do not use this directory at all. Only non-emulated games (native, HTML5)
do make use of it.

## Saves Storage `/mnt/SAVES`

This is where the storage for all the games is stores, being them emulated or not. Depending on the platform, these
games' saves will be stored into:

- Atari 2600: `/mnt/SAVES/atari2600`.
- Atari 5200: `/mnt/SAVES/atari5200`.
- Atari 7800: `/mnt/SAVES/atari7800`.
- Atari Jaguar: `/mnt/SAVES/atarijaguar`.
- Atari Lynx: `/mnt/SAVES/atarilynx`.
- DOS Box: `/mnt/SAVES/dosbox`.
- SEGA Genesis: `/mnt/SAVES/genesis`.
- SEGA Game Gear: `/mnt/SAVES/gamegear`.
- SEGA Master System: `/mnt/SAVES/mastersystem`.
- SEGA CD: `/mnt/SAVES/segacd`.
- Nintendo (NES): `/mnt/SAVES/nes`.
- Nintendo (SNES): `/mnt/SAVES/snes`.
- Nintendo Gameboy Color: `/mnt/SAVES/gbcolor`.
- Nintendo Gameboy Advance: `/mnt/SAVES/gba`.
- Nintendo DS: `/mnt/SAVES/nds`.
- Nintendo 64: `/mnt/SAVES/n64`.
- MAME: `/mnt/SAVES/mame`.
- Sony PlayStation: `/mnt/SAVES/ps1`.
- NeoGeo CD: `/mnt/SAVES/neogeocd`.
- NeoGeo Pocket: `/mnt/SAVES/neogeopocket`.
- DragonShark (native games): `/mnt/SAVES/dragonshark`.

Please note that each DragonShark savefile can span up to 20mb.

These directories are specified in the emulators configuration files described earlier.

## Configurations for emulated games

This console supports all the previously mentioned consoles (save for DragonShark, which is the native support). While
RetroArch can launch games from any specified path and store where the user pleases, EmulationStation is just an
interface to it, divided by sections.

The sections are all of them defined in `/home/pi/.emulationstation/es_systems.cfg`. This file is an XML file with all
the said entries, each matching the proper extensions and command lines.

Some insights are given by default:

- The default paths for the __ROMs__ is: `/media/pi/DATA`. Today that path _does not exist_ and can/should be changed
by the user, when they mount their storage media and set it up via the DragonShark UI or a DragonShark helper command.
- The __LibRetro cores__ are stored in `/home/pi/.config/retroarch/cores`. All of them are listed here.

The `es_systems.template.cfg`, located at `/home/pi/.emulationstation/es_systems.template.cfg`, serves as source for
`es_systems.cfg` file but with a variable named `%ROMS%` to be interpolated with whatever new absolute path to the
stored ROMs is intended (the names will be preserved, so users must be sure to respect the subdirectory names for each
console).

Also, each emulated game has its own RetroArch configuration extension:

1. The names of the platforms are _the same suffixes in the /mnt/SAVES directories_, save for `dragonshark` which is
   not emulated.
2. In the `es_systems.cfg` file, there are also many configuration files mentioned (each being a separate config for
   RetroArch launching): `/home/pi/.config/retroarch/config/*.cfg` each holding:
	1. Save for the n64 one (which is named mupen64plus), all the filenames refer the platform.
    2. Only save directories is, so far, configured there.
