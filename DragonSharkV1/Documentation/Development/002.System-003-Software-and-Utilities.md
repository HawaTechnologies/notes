# System Setup : Software and Utilities

This document describes extra software that is needed on top of the base system to work for the purpose
of being a video games console. Two sections will exist in this document:

1. The external software (typically, for emulated games) that is installed on top of the Raspbian image,
   and is maintained by the community and typically supported as a package in the Raspbian repositories.
2. The Hawa-provided custom utilities, developed for this video games console.

## Well-known software

### NetworkManager utility

First, installing NetworkManager and setting up the current user (`pi`, typically):

```shell
sudo apt update
sudo apt install network-manager
sudo systemctl disable dhcpcd
sudo systemctl stop dhcpcd
sudo systemctl enable NetworkManager
sudo systemctl start NetworkManager
sudo usermod -aG netdev $USER # Or: pi insstead of $USER
sudo visudo
```

Then, inside `visudo`, write these lines and save+exit (they apply for `pi` user):

```shell
pi ALL=(ALL) NOPASSWD: /usr/bin/nmcli
pi ALL=(ALL) NOPASSWD: /usr/bin/timdatectl
```

### Web Browsers

A `chromium-browser` is installed. This is installed to run HTML5 games.

### Box86 and Box64

Both `box86` and `box64` are meant to execute native Linux games in those architectures. Installing `box86`
also required adding the `ia32` architecture to the system.

### Python

Python 3.9 is supported as a global interpreter (`python`). This comes out-of-the-box in Raspbian, and
the system can be upgraded to add newer versions if needed.

## RetroArch and EmulationStation

RetroArch is installed (N64 games are not supported) as a libretro-bridging emulator. Also, EmulationStation
(`emulationstation`) is installed.

In addition, 20 libretro cores were built and installed to emulate many well-known retro consoles up to
Nintendo 64 and Nintendo DS (does not include consoles like PlayStation 2, Nintendo GameCube or newer).

The supported consoles for emulation are:

- Atari 2600.
- Atari 5200.
- Atari 7800.
- Atari Jaguar.
- Atari Lynx.
- DOS Box.
- SEGA Genesis.
- SEGA Game Gear.
- SEGA Master System.
- SEGA CD.
- Nintendo (NES).
- Nintendo (SNES).
- Nintendo Gameboy Color (supports B/W Gameboy games as well).
- Nintendo Gameboy Advance.
- Nintendo DS.
- Nintendo 64.
- MAME.
- Sony PlayStation.
- NeoGeo CD.
- NeoGeo Pocket.

## Hawa-provided utilities

Aside from the described base and community tools, DragonShark V1 includes the following Hawa-provided
tools. These are by default developed and maintained by Hawa and installed as binaries. This section
covers:

1. VirtualPad service.
2. DragonShark binaries.
3. Launcher service.
4. The upcomming UI.

### VirtualPad service

This service is a LAN-enabled service (it works when the console has a LAN interface, like a Wi-Fi
dongle or a direct cable connection). VirtualPad consists of two elements:

1. The server, mounted at `/opt/Hawa/virtualpad`. Details of it are given
   [in this repository](https://github.com/HawaTechnologies/virtualpad-server).
2. The client, installed on Wi-Fi-enabled mobile devices. Details are given
   [in this repository](https://github.com/HawaTechnologies/virtualpad-client). Up to 8 clients can
   be connected in a single VirtualPad server. A Redot / Godot compiler of version 4.x is enough to
   build this project from scratch.

This server uses both TCP sockets and UNIX sockets to communicate:

1. Port 2357 for clients.
2. Port 2358 for broadcast (when a utility wants to get an update state of the controls and server,
   but doesn't need -itself- to interact with the server, it registers itself as a utility).
3. UNIX socket /run/Hawa/virtualpad-admin.sock for the admin tool.

### Native games launcher

While `emulationstation` + `retroarch` are used to launch emulated games in their own sandbox, there
is an extra service in charge of launching native and HTML5 games on its own.

At first sight, it may be trivial for native games to be launched indirectly, but there is a catch
for both types of games:

1. HTML5 games require a special launch mode. They run, sandboxed, in a kiosk-mode Chromium browser.
2. Native games run on their own. While on lack of a better name for this category, Native does not
   refer to natively-built games but, instead, games able to run in Linux/ARM64. This might be done
   by being true native games or by using an interpreter (e.g. python, or any other in-game provided
   interpreter).
3. Native games run in a _sandboxed_ mode. This is done through a _firejail_-ed low-privilege user
   (`gamer`) whose `$HOME` is completely isolated and have no right to write elsewhere.
4. Both types of games have its lifecycle tightly related to `/mnt/CURRENT_SAVE` out of the box. They
   just need to read from, and write to, any subdirectory of `$HOME` (`/home/gamer`). This is done
   completely by this launcher.
5. The shortcut `start` + `select`, held by 3 seconds, abort the game execution. This is particularly
   useful when the HTML5 game does not provide a graceful `window.close` call (which is the case for
   most games) or when a native game gets stuck somewhere.

This service is installed at `/opt/Hawa/launcher`, and more details of its implementation are given
[in this repository](https://github.com/HawaTechnologies/launcher).

### DragonShark binaries

A lot of `dragonshark-` prefixed commands are installed. They serve the purposes of:

1. Configuring the location of DragonShark games (both emulated and native).
2. Managing the backup of saves.
3. Managing external devices (storage ones).
4. Managing networks: LAN TCP/IPv4 interfaces, and WLAN interfaces in particular.

Although they're used by UI applications, they're totally safe to be used by any requiring third party
UI element or plug-in or, some of them, even outside DragonShark contexts entirely.

These binaries are installed at `/usr/local/bin`, and more details of their implementation are given
[in this repository](https://github.com/HawaTechnologies/dragonshark-helpers).

### The upcomming UI

A UI application will be provided as well, installed at `/opt/Hawa/dragonshark-ui`. This tool is the
main entrypoint of the console for end users and is meant to be interacted with game pads only (e.g.
VirtualPad gamepads are totally supported and, in fact, advertised right there).

That project is in active development and will, at least, support:

1. System configuration (master volume, date and time).
2. Network configuration (Wi-Fi interfaces).
3. VirtualPad management.
4. Launching the bare `emulationstation` launcher.
5. Launching binary games through the already-described `launcher` utility.

More details of its implementation are given [in this repository](https://github.com/HawaTechnologies/dragonshark-ui).
